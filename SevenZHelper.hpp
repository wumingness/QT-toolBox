#pragma comment(lib,"bit7z64.lib")
#pragma once
#include <iostream>
#include <string>
#include <functional>
#include <QtDebug>
#include "sevenztype.h"
#include "include/bit7z.hpp"
#include "include/bit7zlibrary.hpp"


using namespace std;
using namespace bit7z;


class SevenZHelper
{
private:
    void Compress(SevenZType type, const wstring& Src, const wstring& Dest, const wstring& Password);	//???
    void Extract(SevenZType type, const wstring& Src, const wstring& Dest, const wstring& Password);    //???

    void GetFileSuffix(const wstring& Path);//?????????

    void TotalSizeCB(uint64_t total_size);	//???????????????§³????????
    void ProgressCB(uint64_t size);			//???????
    void FileNameCB(wstring filename);	    //????????????§Ö?????????????????????
    void setThread(QThread* t);

    typedef std::function<void(double progress)> ProgressCallback;		//???????????
    typedef std::function<void(std::wstring filename)> MyFileCallback;	//??????????????§Ö?????????????????????
    typedef std::function<void(const bit7z::BitException&)> BitExceptionCallback;	//???????????
    ProgressCallback m_pProgressFunc;
    MyFileCallback m_pFileFunc;
    BitExceptionCallback m_pExpFunc;

    wstring m_SourcePath;		//????¡¤??
    wstring m_DestDir;			//???¡¤??
    vector <wstring> m_FileSuffix;		//?????¡¤????????????????
    uint64_t m_FileSize;		//??????§³
    wstring DefaultSuffix;		//?????
    SevenZType m_OpType;		//??????????????
    uint64_t TotalSize;			//????????????????????§³
    bit7z::BitCompressionLevel m_Level; //???????
    bit7z::BitCompressionMethod m_Method; //??????
    uint64_t m_Dictionsize;     //?????§³
    bool m_Solidmode;           //?????
    bool m_Updatemode;
    double progress;

public:
    SevenZHelper();
    ~SevenZHelper();

    double getProgress();

    void CompressDecompression(SevenZType type, const wstring& Src, const wstring& Dest = TEXT(""), const wstring& Password = TEXT(""),
        const bit7z::BitCompressionLevel Level = (bit7z::BitCompressionLevel)-1,
        const bit7z::BitCompressionMethod Method = (bit7z::BitCompressionMethod)-1,
        const uint64_t Dicsize = 0, const bool ifSolid = true, const bool ifUpdate = false);

    //?????????y??????????
    void SetProgressCB(ProgressCallback upcFunc);

    //????????????????????
    void SetBitExceptionCallback(BitExceptionCallback ExceptionFunc);

    //?????????????????????§Ó????????????????????
    void SetFileNameCurOperatorCallback(MyFileCallback ufcFunc);

};
